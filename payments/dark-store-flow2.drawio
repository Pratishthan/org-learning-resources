<mxfile host="app.diagrams.net" modified="2025-09-02T00:00:00.000Z" agent="AI" version="24.7.5" type="device">
  <diagram id="dark-store-flow" name="Dark Store Replenishment Flow">
    <mxGraphModel dx="1470" dy="868" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1600" pageHeight="1000" math="0" shadow="0">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>

        <!-- Swimlanes / Groups -->
        <mxCell id="api" value="Store API (Loopback3/oe-cloud)" style="swimlane;childLayout=stackLayout;horizontal=1;startSize=28;horizontalStack=0;resizeParent=1;collapsible=1;rounded=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="60" y="80" width="300" height="220" as="geometry"/>
        </mxCell>

        <mxCell id="redis" value="Redis (Cache/Idempotency/Locks)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="60" y="340" width="300" height="80" as="geometry"/>
        </mxCell>

        <mxCell id="mq" value="RabbitMQ (Topic Exchanges / Queues)" style="swimlane;childLayout=stackLayout;horizontal=1;startSize=28;horizontalStack=0;resizeParent=1;collapsible=1;rounded=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="400" y="80" width="360" height="300" as="geometry"/>
        </mxCell>

        <mxCell id="invWorker" value="Inventory Worker" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="800" y="80" width="240" height="120" as="geometry"/>
        </mxCell>

        <mxCell id="whWorker" value="Warehouse Worker" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="800" y="220" width="240" height="120" as="geometry"/>
        </mxCell>

        <mxCell id="db" value="RDBMS (Postgres)" style="shape=cylinder;whiteSpace=wrap;html=1;boundedLbl=1;size=15;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="1080" y="140" width="220" height="140" as="geometry"/>
        </mxCell>

        <mxCell id="user" value="User / Client App" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#000000;" vertex="1" parent="1">
          <mxGeometry x="60" y="20" width="200" height="40" as="geometry"/>
        </mxCell>

        <!-- API internal nodes -->
        <mxCell id="apiOrder" value="POST /orders\n(Reserve stock, emit order.created)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#6c8ebf;" vertex="1" parent="api">
          <mxGeometry x="20" y="40" width="260" height="70" as="geometry"/>
        </mxCell>

        <mxCell id="apiInv" value="Inventory endpoints\n(Update on_hand, invalidate cache)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#6c8ebf;" vertex="1" parent="api">
          <mxGeometry x="20" y="120" width="260" height="70" as="geometry"/>
        </mxCell>

        <!-- RabbitMQ internals -->
        <mxCell id="exInv" value="inventory.events\n(stock.low, stock.replenished)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#9673a6;" vertex="1" parent="mq">
          <mxGeometry x="20" y="40" width="320" height="60" as="geometry"/>
        </mxCell>
        <mxCell id="exOrder" value="order.events\n(order.created)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#9673a6;" vertex="1" parent="mq">
          <mxGeometry x="20" y="110" width="320" height="50" as="geometry"/>
        </mxCell>
        <mxCell id="exWh" value="warehouse.events\n(replenishment.created, shipment.*)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#9673a6;" vertex="1" parent="mq">
          <mxGeometry x="20" y="170" width="320" height="60" as="geometry"/>
        </mxCell>
        <mxCell id="qLow" value="q.inventory.low-stock" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#9673a6;" vertex="1" parent="mq">
          <mxGeometry x="20" y="240" width="150" height="40" as="geometry"/>
        </mxCell>
        <mxCell id="qRepl" value="q.warehouse.replenish" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#9673a6;" vertex="1" parent="mq">
          <mxGeometry x="190" y="240" width="150" height="40" as="geometry"/>
        </mxCell>

        <!-- Edges -->
        <mxCell id="eUserToOrder" edge="1" parent="1" source="user" target="api">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="eOrderToRedisRead" value="Check cache" style="endArrow=classic;" edge="1" parent="1" source="api" target="redis">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="eOrderToDB" value="Reserve items (txn)" style="endArrow=classic;" edge="1" parent="1" source="api" target="db">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="eApiToOrderEx" value="order.created" style="endArrow=classic;dashed=1;" edge="1" parent="1" source="api" target="exOrder">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="eApiToInvEx" value="stock.low (if near/below threshold)" style="endArrow=classic;dashed=1;" edge="1" parent="1" source="api" target="exInv">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="eInvExToQLow" edge="1" parent="1" source="exInv" target="qLow">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="eWhExToQRepl" edge="1" parent="1" source="exWh" target="qRepl">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="eQLowToInvW" value="Consume stock.low" style="endArrow=classic;" edge="1" parent="1" source="qLow" target="invWorker">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="eInvWToDB" value="Create replenishment_request" style="endArrow=classic;" edge="1" parent="1" source="invWorker" target="db">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="eInvWToWhEx" value="replenishment.created" style="endArrow=classic;dashed=1;" edge="1" parent="1" source="invWorker" target="exWh">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="eQReplToWhW" value="Consume replenishment.created" style="endArrow=classic;" edge="1" parent="1" source="qRepl" target="whWorker">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="eWhWToDB" value="Dispatch shipment, update records" style="endArrow=classic;" edge="1" parent="1" source="whWorker" target="db">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="eWhWToInvEx" value="stock.replenished" style="endArrow=classic;dashed=1;" edge="1" parent="1" source="whWorker" target="exInv">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="eInvExToAPI" value="Consume stock.replenished" style="endArrow=classic;" edge="1" parent="1" source="exInv" target="api">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="eAPIToDBUpd" value="Update on_hand" style="endArrow=classic;" edge="1" parent="1" source="api" target="db">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="eAPIToRedisInv" value="Invalidate/Update cache" style="endArrow=classic;" edge="1" parent="1" source="api" target="redis">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>

